
# autoconf tutorial: 
# http://www.galassi.org/mark//mydocs/autoconf_tutorial_2.html

SHELL = /bin/sh
VPATH = @srcdir@

subdirs = @subdirs@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = $(exec_prefix)/bin
infodir = $(prefix)/info
libdir = $(prefix)/lib/gnudl
mandir = $(prefix)/man/man1

EXEEXT=@EXEEXT@

CC = @CC@
CPPFLAGS = @CPPFLAGS@
CFLAGS = $(CPPFLAGS) @CFLAGS@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@
INSTALL = @INSTALL@

ENABLE_JACK=@enable_jack@
ENABLE_PULSE=@enable_pulseaudio@
ENABLE_DIRECTFB=@enable_directfb@

-include config.mk

CFLAGS += -D_GNU_SOURCE=1 -Wall -Wextra -fno-strict-aliasing -fsingle-precision-constant 
#-Wunsafe-loop-optimizations 
CFLAGS += -I "./src" 

#TODO: split orc flags out like everyting else
ifeq (@enable_orc@,yes)
	CFLAGS += @ORC_CFLAGS@ @ORC_LIBS@
endif

ifdef DEBUG
	CFLAGS += -ggdb -O0
else
	CFLAGS += -ggdb -O2 -finline-functions -maccumulate-outgoing-args -fdelete-null-pointer-checks 
	CFLAGS += -funroll-loops -fpeel-loops -funswitch-loops -fvariable-expansion-in-unroller
	CFLAGS += -ftree-vectorize -ftree-loop-ivcanon -ftree-loop-im -ftree-loop-linear -funsafe-loop-optimizations 
	CFLAGS += -fgcse-las -fgcse-sm -fmodulo-sched 
	CFLAGS += -fmerge-all-constants

# on gcc 4.3 set precsicion of FPU to 32 bits (can get speed up for floats)
# do this since everywhere inside our code we use only floats
# -mrecip = let gcc generate the RCPSS and RSQRTSS instructions (fast recipricol)
	CFLAGS += -mpc32 -mrecip

	CFLAGS += -fmodulo-sched-allow-regmoves -fgcse-after-reload -fsee -fipa-cp
	CFLAGS += -fsched-stalled-insns=2 -fsched-stalled-insns-dep=2 -fvect-cost-model -ftracer
	CFLAGS += -ffast-math  -fassociative-math -freciprocal-math -fno-signed-zeros
	
	CFLAGS += -Wl,-O1 -Wl,--sort-common -Wl,--as-needed
endif

CFLAGS += -Wl,--as-needed

#CFLAGS := $(shell ./gcc-optioncheck $(CFLAGS))

PA_FLAGS = @PORTAUDIO_CFLAGS@ @PORTAUDIO_LIBS@ @FFTW_CFLAGS@ @FFTW_LIBS@
JACK_FLAGS = @JACK_CFLAGS@ @JACK_LIBS@
PULSE_FLAGS = @PULSE_CFLAGS@ @PULSE_LIBS@
AUDIO_FLAGS = $(PA_FLAGS) $(JACK_FLAGS) $(PULSE_FLAGS)
SDL_FLAGS = @SDL_CFLAGS@ @SDL_LIBS@ -lSDL_ttf -lm
DFB_FLAGS = @DIRECTFB_CFLAGS@ @DIRECTFB_LIBS@

ALL_BINS := bin/sdl-test$(EXEEXT) bin/sdlthread-test$(EXEEXT) bin/audio-test$(EXEEXT)
ifeq (@enable_opengl@,yes) 
	ALL_BINS += bin/glsl-test$(EXEEXT)
endif

AUDIO_SRCS = src/audio/audio.c src/audio/beat.c src/audio/portaudio.c 

COMMON_SRCS = src/terminusIBM.c src/sdl-misc.c src/mtwist/mtwist.c src/pallet.c src/optproc.c src/points.c

ifeq ($(ENABLE_JACK),yes)
AUDIO_SRCS += src/audio/jack.c
endif
ifeq ($(ENABLE_PULSE),yes)
AUDIO_SRCS += src/audio/pulseaudio.c
endif

AUDIO_OBJS = $(AUDIO_SRCS:.c=.o)

ifeq ($(ENABLE_DIRECTFB),yes)
ALL_BINS += bin/dfb-test$(EXEEXT)
endif

ifneq (@enable_locking_tb@,yes)
TRIBUF_SRCS = src/atomic_tribuf.c
else
TRIBUF_SRCS = src/tribuf.c
endif 

all: $(ALL_BINS)

dfb-run: bin/dfb-test
	bin/dfb-test

run: bin/sdlthread-test
	bin/sdlthread-test

clean:
	rm -f src/*.o
	rm -f bin/dfb-test bin/audio-test bin/sdl-test bin/sdlthread-test

distclean: clean
	rm -f Makefile config.h config.status config.cache config.log configure stamp-h

.PHONY: all dfb dfb-run run clean

config.mk:
	touch config.mk

bin/sdl-test$(EXEEXT): src/sdl.c $(COMMON_SRCS) $(AUDIO_SRCS) $(TRIBUF_SRCS) src/maxsrc.c src/map.c src/pixmisc.c src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_SDL \
	src/sdl.c $(COMMON_SRCS) $(AUDIO_SRCS) $(TRIBUF_SRCS) src/maxsrc.c src/map.c src/pixmisc.c \
	$(SDL_FLAGS) $(AUDIO_FLAGS) -o $@

bin/glsl-test$(EXEEXT): src/opengl/glsl.c src/opengl/glmisc.c src/opengl/gl_maxsrc.c src/opengl/glpallet.c src/opengl/mandelbrot.c src/opengl/glmap.c $(COMMON_SRCS) $(AUDIO_SRCS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_SDL \
	src/opengl/glsl.c src/opengl/glmisc.c src/opengl/gl_maxsrc.c src/opengl/glpallet.c src/opengl/mandelbrot.c src/opengl/glmap.c \
	$(COMMON_SRCS)  $(AUDIO_SRCS) $(TRIBUF_SRCS) \
	$(SDL_FLAGS) $(AUDIO_FLAGS) -L/usr/X11R6/lib -lGL -lGLU -lGLEW -o $@

bin/sdlthread-test$(EXEEXT): src/sdl-thread.c $(COMMON_SRCS)  $(AUDIO_SRCS) $(TRIBUF_SRCS) src/maxsrc.c src/map.c src/pixmisc.c src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_SDL -DTRIBUF_LOCKING \
	src/sdl-thread.c $(COMMON_SRCS) $(AUDIO_SRCS) $(TRIBUF_SRCS) src/maxsrc.c src/map.c src/pixmisc.c \
	$(SDL_FLAGS) $(AUDIO_FLAGS) -o $@

bin/dfb-test$(EXEEXT): src/directfb.c src/map.c src/pallet.c src/pixmisc.c src/optproc.c $(TRIBUF_SRCS) src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_DIRECTFB \
	src/directfb.c src/map.c src/pallet.c src/pixmisc.c src/optproc.c $(TRIBUF_SRCS) \
	$(DFB_FLAGS) $(AUDIO_FLAGS) -o $@

bin/audio-test$(EXEEXT): $(AUDIO_SRCS) src/audio/sdl-test.c src/sdl-misc.c src/optproc.c $(TRIBUF_SRCS) src/line.c
	$(CC) $(CFLAGS) -DFFT_TRIBUF -DUSE_SDL \
	$(AUDIO_SRCS) src/audio/sdl-test.c src/sdl-misc.c src/terminusIBM.c src/optproc.c $(TRIBUF_SRCS) src/line.c \
	$(SDL_FLAGS) $(AUDIO_FLAGS) -o $@


src/audio/%.o: src/audio/%.c Makefile config.mk
	$(CC) $(CFLAGS) $(AUDIO_FLAGS) -c $< -o $@
	
%.s: %.c src/*.h Makefile config.mk
	$(CC) $< $(CFLAGS) -S -o $@


# automatic re-running of configure if the ocnfigure.in file has changed
configure: configure.ac
	autoconf

# autoheader might not change config.h.in, so touch a stamp file
src/config.h.in: stamp-h.in
stamp-h.in: configure.ac
		autoheader
		echo timestamp > stamp-h.in

src/config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status
Makefile: Makefile.in config.status
	./config.status
config.status: configure
	./config.status --recheck
