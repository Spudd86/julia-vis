# @configure_input@
# autoconf tutorial: 
# http://www.galassi.org/mark//mydocs/autoconf_tutorial_2.html

SHELL = /bin/sh
VPATH = @srcdir@

subdirs = @subdirs@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = $(exec_prefix)/bin
infodir = $(prefix)/info
libdir = $(prefix)/lib/gnudl
mandir = $(prefix)/man/man1

EXEEXT=@EXEEXT@

CC = @CC@
CPPFLAGS = @CPPFLAGS@
CFLAGS = $(CPPFLAGS) @CFLAGS@
LDFLAGS = @LDFLAGS@ -Wl,-O1,--sort-common -Wl,--as-needed -Wl,--gc-sections -Wl,-no-undefined
LIBS = @LIBS@
INSTALL = @INSTALL@

ENABLE_JACK=@enable_jack@
ENABLE_PULSE=@enable_pulseaudio@
ENABLE_PORTAUDIO=@enable_portaudio@
ENABLE_SNDFILE=@enable_sndfile@
ENABLE_GL=@enable_opengl@
ENABLE_EGL=@enable_egl@

CFLAGS += -Wall -Wextra -Wdouble-promotion \
	-Wnested-externs -Wpointer-arith \
	-Wsign-compare -Wchar-subscripts \
	-Wstrict-prototypes -Wshadow \
	-Wformat-security -Wtype-limits \
	-Wcast-qual -Wwrite-strings -Wlogical-op -Waggregate-return \
	-Wunsuffixed-float-constants \
	-fno-strict-aliasing
#-Wunsafe-loop-optimizations -Wconversion -Wstrict-prototypes 
CFLAGS += -I "./src" -I "./tinycthread"

-include config.mk

#TODO: split orc flags out like everyting else
ifeq (@enable_orc@,yes)
	CFLAGS += @ORC_CFLAGS@ @ORC_LIBS@
endif

ifdef DEBUG
	CFLAGS += -ggdb -Og
else
	CFLAGS += -DNDEBUG
	CFLAGS += -g -O2 
	#CFLAGS += -finline-functions -maccumulate-outgoing-args -fdelete-null-pointer-checks 
	#CFLAGS += -funroll-loops -fpeel-loops -funswitch-loops -fvariable-expansion-in-unroller
	#CFLAGS += -ftree-vectorize -ftree-loop-ivcanon -ftree-loop-im -ftree-loop-linear 
	#CFLAGS += -funsafe-loop-optimizations 
	#CFLAGS += -fgcse-las -fgcse-sm -fmodulo-sched 
	#CFLAGS += -fmerge-all-constants

# on gcc 4.3 set precsicion of FPU to 32 bits (can get speed up for floats)
# do this since everywhere inside our code we use only floats
# -mrecip = let gcc generate the RCPSS and RSQRTSS instructions (fast recipricol)
	#CFLAGS += -mpc32 -mrecip=all
	#CFLAGS += -ffast-math  -fassociative-math -freciprocal-math -fno-signed-zeros
endif

#CFLAGS := $(shell ./gcc-optioncheck $(CFLAGS))

PA_CFLAGS = @PORTAUDIO_CFLAGS@
PA_LIBS = @PORTAUDIO_LIBS@
JACK_CFLAGS = @JACK_CFLAGS@
JACK_LIBS = @JACK_LIBS@
PULSE_CFLAGS = @PULSE_CFLAGS@
PULSE_LIBS = @PULSE_LIBS@
SNDFILE_CFLAGS = @SNDFILE_CFLAGS@
SNDFILE_LIBS = @SNDFILE_LIBS@
AUDIO_CFLAGS = $(PA_CFLAGS) $(JACK_CFLAGS) $(PULSE_CFLAGS) $(SNDFILE_CFLAGS)
AUDIO_LIBS = $(PA_LIBS) $(JACK_LIBS) $(PULSE_LIBS) $(SNDFILE_LIBS)
SDL_FLAGS = @SDL_CFLAGS@ @SDL_LIBS@
GL_CFLAGS = @GL_CFLAGS@ @GLU_CFLAGS@
GL_LIBS = @GL_LIBS@ @GLU_LIBS@
EGL_CFLAGS = @EGL_CFLAGS@
EGL_LIBS = @EGL_LIBS@
KMS_CFLAGS = @GBM_CFLAGS@ @DRM_CFLAGS@
KMS_LIBS = @GBM_LIBS@ @DRM_LIBS@

GL_LOADER = src/opengl/gl_14.o

ALL_BINS := bin/sdl-test$(EXEEXT) bin/sdlthread-test$(EXEEXT) bin/audio-test$(EXEEXT) bin/pal-test$(EXEEXT)
ifeq ($(ENABLE_GL),yes) 
	ALL_BINS += bin/gl-test$(EXEEXT)
endif
ifeq ($(ENABLE_EGL),yes) 
	ALL_BINS += bin/egl-test$(EXEEXT)
endif

AUDIO_SRCS = src/audio/audio.c src/audio/beat.c src/audio/fft.c

COMMON_SRCS = src/terminusIBM.c src/isaac/isaac.c src/pallet.c src/optproc.c src/points.c

SOFT_SRCS = src/software/map.c src/software/maxsrc.c src/software/palletblit.c src/software/pixmisc.c

SDL_SOFT_SRCS = src/software/sdl/sdlhelp.c src/sdl/sdlsetup.c

X86_SOFT_SRCS = src/software/x86/cpuid.c src/software/x86/mmx.c src/software/x86/sse.c src/software/x86/sse2.c src/software/x86/sse4_1.c

GL_SRCS = src/opengl/glmain.c src/opengl/glmisc.c src/opengl/glsl/glsl_maxsrc.c src/opengl/fixed/glf_maxsrc.c src/opengl/glscope.c src/opengl/glsl/glsl_pallet.c src/opengl/fixed/glf_pal.c src/opengl/fixed/glmap.c src/opengl/mandelbrot.c src/opengl/offscreen.c src/opengl/glsl/glsl_fract.c src/opengl/fixed/glf_fract.c

GL_SDL_SRCS = src/sdl/sdlglmain.c src/sdl/sdlsetup.c

ifeq ($(ENABLE_JACK),yes)
AUDIO_DRV_SRCS += src/audio/jack.c
endif
ifeq ($(ENABLE_PULSE),yes)
AUDIO_DRV_SRCS += src/audio/pulseaudio.c
endif
ifeq ($(ENABLE_PORTAUDIO),yes)
AUDIO_DRV_SRCS += src/audio/portaudio.c
endif
ifeq ($(ENABLE_SNDFILE),yes)
AUDIO_DRV_SRCS += src/audio/filedecode.c tinycthread/tinycthread.c
endif

AUDIO_DRV_OBJS = $(AUDIO_DRV_SRCS:.c=.o)

AUDIO_SRCS += $(AUDIO_DRV_SRCS)

AUDIO_OBJS = $(AUDIO_SRCS:.c=.o)

COMMON_OBJS = $(COMMON_SRCS:.c=.o)

SOFT_OBJS = $(SOFT_SRCS:.c=.o)

X86_SOFT_OBJS = $(X86_SOFT_SRCS:.c=.o)

TRIBUF_SRCS = src/tribuf.c

ALL_OBJS = $(AUDIO_DRV_OBJS) $(AUDIO_OBJS) $(COMMON_OBJS) $(SOFT_OBJS) $(X86_SOFT_OBJS)

DEPS = $(ALL_OBJS:.o=.dep)

ifeq (@disable_atomics@,yes)
CFLAGS += -DTB_NO_ATOMIC
endif

all: $(ALL_BINS)

run: bin/sdlthread-test
	bin/sdlthread-test

clean:
	-rm -f $(ALL_OBJS)
	-rm -f src/opengl/gl_14.o
	-rm -f $(ALL_BINS)

distclean: clean
	-rm -f Makefile config.h config.status config.cache config.log configure stamp-h

.PHONY: all dfb dfb-run run clean

config.mk:
	touch config.mk

bin/gl-test$(EXEEXT): $(GL_LOADER) $(GL_SDL_SRCS) $(GL_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_GL \
	$(GL_SDL_SRCS) $(GL_SRCS) \
	$(COMMON_OBJS)  $(AUDIO_OBJS) $(TRIBUF_SRCS) \
	$(GL_LOADER) $(SDL_FLAGS) $(AUDIO_CFLAGS) $(GL_CFLAGS) $(LDFLAGS) $(AUDIO_LIBS) $(GL_LIBS) $(LIBS) -o $@

bin/glscope-test$(EXEEXT): $(GL_LOADER) $(GL_SDL_SRCS) src/opengl/glscope-test.c src/opengl/glscope.c src/opengl/glmisc.c $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_GL \
	$(GL_SDL_SRCS) src/opengl/glscope-test.c src/opengl/glscope.c src/opengl/glmisc.c \
	$(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) \
	$(GL_LOADER) $(SDL_FLAGS) $(AUDIO_CFLAGS) $(GL_CFLAGS) $(LDFLAGS) $(AUDIO_LIBS) $(GL_LIBS) $(LIBS) -o $@
	
bin/glscopetris-test$(EXEEXT): $(GL_LOADER) $(GL_SDL_SRCS) src/tess/scopetris.c src/tess/hset.c src/opengl/glmisc.c $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_GL -DSCOPETRIS_TEST \
	$(GL_SDL_SRCS) src/tess/scopetris.c src/tess/hset.c src/opengl/glmaxsrc.c src/opengl/glmisc.c \
	src/opengl/glmap.c \
	$(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) \
	$(GL_LOADER) $(SDL_FLAGS) $(AUDIO_CFLAGS) $(GL_CFLAGS) $(LDFLAGS) $(AUDIO_LIBS) $(GL_LIBS) $(LIBS) -o $@

bin/glx-test$(EXEEXT): $(GL_LOADER) src/opengl/glxmain.c $(GL_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_GL \
	src/opengl/glxmain.c $(GL_SRCS) \
	src/opengl/glx_gen.c \
	$(COMMON_OBJS)  $(AUDIO_OBJS) $(TRIBUF_SRCS) \
	$(AUDIO_CFLAGS) $(GL_CFLAGS) $(GL_LOADER) $(LDFLAGS) $(GL_LIBS) $(AUDIO_LIBS) $(LIBS) -o $@

bin/fps-test$(EXEEXT): $(GL_LOADER) src/opengl/fpsmain.c src/opengl/fpsservo/fpsservo.c src/opengl/glx_gen.c $(GL_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_GL \
	src/opengl/fpsmain.c $(GL_SRCS) \
	src/opengl/fpsservo/fpsservo.c \
	src/opengl/glx_gen.c \
	$(COMMON_OBJS)  $(AUDIO_OBJS) $(TRIBUF_SRCS) \
	$(AUDIO_CFLAGS) $(GL_CFLAGS) $(GL_LOADER) $(LDFLAGS) $(AUDIO_LIBS) $(GL_LIBS) $(LIBS) -o $@

bin/egl-test$(EXEEXT): $(GL_LOADER) src/opengl/eglmain.c src/opengl/egl/xegl.c $(GL_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_GL \
	src/opengl/eglmain.c src/opengl/egl/xegl.c $(GL_SRCS) \
	$(COMMON_OBJS)  $(AUDIO_OBJS) $(TRIBUF_SRCS) \
	$(EGL_CFLAGS) $(EGL_LIBS) $(AUDIO_CFLAGS) $(GL_CFLAGS) $(GL_LOADER) $(LDFLAGS) $(AUDIO_LIBS) $(GL_LIBS) $(LIBS) -o $@

bin/kms-test$(EXEEXT): $(GL_LOADER) src/opengl/egl/kms.c $(GL_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) src/opengl/glmisc.h src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) -DUSE_GL \
	src/opengl/egl/kms.c $(GL_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) \
	$(AUDIO_CFLAGS) \
	$(LDFLAGS) \
	$(KMS_CFLAGS) $(KMS_LIBS) $(EGL_CFLAGS) $(EGL_LIBS) \
	$(GL_CFLAGS) $(GL_LOADER) $(GL_LIBS) $(AUDIO_LIBS) $(LIBS) -o $@

src/opengl/gl_14.o: src/opengl/gl_14.c
	$(CC) -g -O2 $(GL_CFLAGS) -c $< -o $@

bin/sdl-test$(EXEEXT): src/software/sdl/sdl.c $(SDL_SOFT_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) $(SOFT_OBJS) $(X86_SOFT_OBJS) src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) \
	src/software/sdl/sdl.c $(SDL_SOFT_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) $(SOFT_OBJS) $(X86_SOFT_OBJS) \
	$(SDL_FLAGS) $(AUDIO_CFLAGS) $(LDFLAGS) $(AUDIO_LIBS) $(LIBS) -o $@

bin/sdlthread-test$(EXEEXT): src/software/sdl/sdl-thread.c $(SDL_SOFT_SRCS) $(COMMON_OBJS)  $(AUDIO_OBJS) $(TRIBUF_SRCS) $(SOFT_OBJS) $(X86_SOFT_OBJS) src/points.h src/common.h Makefile config.mk
	$(CC) $(CFLAGS) \
	src/software/sdl/sdl-thread.c $(SDL_SOFT_SRCS) $(COMMON_OBJS) $(AUDIO_OBJS) $(TRIBUF_SRCS) $(SOFT_OBJS) $(X86_SOFT_OBJS) \
	$(SDL_FLAGS) $(AUDIO_CFLAGS) $(LDFLAGS) $(AUDIO_LIBS) $(LIBS) -o $@

bin/audio-test$(EXEEXT): $(AUDIO_DRV_OBJS) src/sdl/audiotest.c src/audio/beat.o src/audio/fft.o src/audio/rb.o $(SDL_SOFT_SRCS) src/terminusIBM.o src/optproc.o src/software/sdl/line.c
	$(CC) $(CFLAGS) \
	$(AUDIO_DRV_OBJS) src/sdl/audiotest.c src/audio/beat.o src/audio/fft.o src/audio/rb.o $(SDL_SOFT_SRCS) src/terminusIBM.o src/optproc.o src/software/sdl/line.c \
	$(SDL_FLAGS) $(AUDIO_CFLAGS) $(LDFLAGS) $(AUDIO_LIBS) $(LIBS) -o $@

bin/pal-test$(EXEEXT): src/software/sdl/test_palletblit.c $(SDL_SOFT_SRCS) $(COMMON_OBJS) $(SOFT_OBJS) $(X86_SOFT_OBJS) src/common.h Makefile config.mk
	$(CC) $(CFLAGS) \
	src/software/sdl/test_palletblit.c $(SDL_SOFT_SRCS) $(COMMON_OBJS) $(SOFT_OBJS) $(X86_SOFT_OBJS) \
	$(SDL_FLAGS) $(LDFLAGS) $(LIBS) -o $@

-include $(DEPS)

src/software/x86/mmx.o: src/software/x86/mmx.c src/software/x86/palblit_mmxsse.c src/common.h src/software/pixmisc.h Makefile config.mk
	@$(CC) -MM -MQ $@ $(CFLAGS) -mno-sse -mmmx $(PP_FLAGS) $< -MF $*.dep
	$(CC) -c $(CFLAGS) -mno-sse -mmmx $(PP_FLAGS) $< -o $@

src/software/x86/sse.o: src/software/x86/sse.c src/software/x86/palblit_mmxsse.c src/common.h src/software/pixmisc.h Makefile config.mk
	@$(CC) -MM -MQ $@ $(CFLAGS) -mno-sse2 -msse $(PP_FLAGS) $< -MF $*.dep
	$(CC) -c $(CFLAGS) -mno-sse2 -msse $(PP_FLAGS) $< -o $@

src/software/x86/sse2.o: src/software/x86/sse2.c src/common.h src/software/pixmisc.h Makefile config.mk
	@$(CC) -MM -MQ $@ $(CFLAGS) -mno-sse3 -msse2 $(PP_FLAGS) $< -MF $*.dep
	$(CC) -c $(CFLAGS) -mno-sse3 -msse2 $(PP_FLAGS) $< -o $@

src/software/x86/sse4_1.o: src/software/x86/sse4_1.c src/common.h src/software/pixmisc.h Makefile config.mk
	@$(CC) -MM -MQ $@ $(CFLAGS) -msse4.1 $(PP_FLAGS) $< -MF $*.dep
	$(CC) -c $(CFLAGS) -msse4.1 $(PP_FLAGS) $< -o $@

tinycthread/%.o: tinycthread/%.c Makefile config.mk
	@$(CC) -MM -MQ $@ @CFLAGS@ @CPPFLAGS@ $< -MF $*.dep
	$(CC) @CFLAGS@ @CPPFLAGS@ -c $< -o $@

src/audio/%.o: src/audio/%.c Makefile config.mk
	@$(CC) -MM -MQ $@ $(CFLAGS) $(AUDIO_CFLAGS) $< -MF $*.dep
	$(CC) $(CFLAGS) $(AUDIO_CFLAGS) -c $< -o $@

src/%.o: src/%.c Makefile config.mk
	@$(CC) -MM -MQ $@ $(CFLAGS) $(PP_FLAGS) $< -MF src/$*.dep
	$(CC) -c $(CFLAGS) $(PP_FLAGS) $< -o $@
	
%.s: %.c src/*.h Makefile config.mk
	$(CC) $< $(CFLAGS) -S -o $@


# automatic re-running of configure if the ocnfigure.in file has changed
configure: configure.ac
	autoconf

# autoheader might not change config.h.in, so touch a stamp file
src/config.h.in: stamp-h.in
stamp-h.in: configure.ac
		autoheader
		echo timestamp > stamp-h.in

src/config.h: stamp-h
stamp-h: src/config.h.in config.status
	./config.status
Makefile: Makefile.in config.status
	./config.status
config.status: configure
	./config.status --recheck

